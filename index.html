<!DOCTYPE html>
<html>

<head>
  <title>Movie Filter</title>
</head>

<body>
  <button id='randomise'>random choice</button>
  <label for="genre">Genre:</label>
  <select id="genre">
    <option value="">All Genres</option>
    <option value="action">Action</option>
    <option value="drama">Drama</option>
    <option value="comedy">Comedy</option>
    <option value="science fiction">Science Fiction</option>
  </select>
  <label for="year">Year:</label>
  <select id="year">
    <option value="">All Decades</option>
    <option value="1970's">1970's</option>
    <option value="1980's">1980's</option>
    <option value="1990's">1990's</option>
    <option value="2000's">2000's</option>
    <option value="2010's">2010's</option>
  </select>
  <label for="language">Language:</label>
  <select id="language">
    <option value="">All Languages</option>
    <option value="english">English</option>
    <option value="spanish">Spanish</option>
    <option value="french">French</option>
    <option value="japanese">Japanese</option>
  </select>
  <label for="orderOption">Sort by:</label>
  <select id="orderOption">
    <option value="default">Randomise</option>
    <option value="azTitle">A-Z by film title</option>
    <option value="azDirector">A-Z by director</option>
    <option value="numberYear">By release year</option>
  </select>
  <button id="submit">Submit</button>
  <p id="resultsNumber"></p>
  <p id="resultsBox"></p>
  <button id="showMore">Show More</button>
  <button id="showAll">Show All</button>
  <div id="movieDetails">
    <h2>Movie Details</h2>
    <img id="poster" src="" alt="Movie Poster">
    <h3 id="movieTitle"></h3>
    <p id="movieOverview"></p>
  </div>
  <script>
    const movies = [
  {
    title: "Enter the Dragon",
    director: "Robert Clouse",
    year: 1973,
    genre: "Action",
    language: "English",
    movieId: 9461
  },
  {
    title: "Dirty Harry",
    director: "Don Siegel",
    year: 1971,
    genre: "Action",
    language: "English",
    movieId: 984
  },
  {
    title: "Die Hard",
    director: "John McTiernan",
    year: 1988,
    genre: "Action",
    language: "English",
    movieId: 562
  },
  {
    title: "Indiana Jones and the Last Crusade",
    director: "Steven Spielberg",
    year: 1989,
    genre: "Action",
    language: "English",
    movieId: 89
  },
];

//remove duplicate listings
function removeDuplicateObjects(arr, property) {
      const uniqueMap = new Map();
      const uniqueArray = [];

      for (const movie of arr) {
        if (!uniqueMap.has(movie[property])) {
          uniqueMap.set(movie[property], true);
          uniqueArray.push(movie);
        }
      }
      arr.length = 0; // Clear the original array
      for (const movie of uniqueArray) {
        arr.push(movie);
      }
    }
    
    removeDuplicateObjects(movies, 'title');



    //switch up array format
    for (let i = 0; i < movies.length; i++) {
      movies[i].genre = movies[i].genre.toLowerCase();
      movies[i].language = movies[i].language.toLowerCase();
      movies[i].year = movies[i].year.toString()
      movies[i].decade = movies[i].year.slice(0, -1) + `0's`
    }

    //
    //DOMS
    const genreDropdown = document.getElementById("genre");
    const yearDropdown = document.getElementById("year");
    const languageDropdown = document.getElementById("language");
    const submitButton = document.getElementById("submit");
    const resultsText = document.getElementById("resultsBox");
    const showMoreButton = document.getElementById("showMore");
    const showAllButton = document.getElementById("showAll")
    const searchResultsNumber = document.getElementById("resultsNumber")
    const sortDropdown = document.getElementById("orderOption")

    showMoreButton.style.display = 'none';
    showAllButton.style.display = 'none'

    let searchResults = []; // Store search results
    let itemsToShow = 1;
    let currentEndIndex = itemsToShow;

    function hideSearchButtons(buttonOne, buttonTwo) {
      buttonOne.style.display = 'none';
      buttonTwo.style.display = 'none';
    }

    function showSearchButtons(buttonOne, buttonTwo) {
      buttonOne.style.display = 'block';
      buttonTwo.style.display = 'block';
    }

    function randomizeIndexesInPlace(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
   
  function getMovieInfo(movieIdNumber) {
      const tmdbBaseUrl = "https://api.themoviedb.org/3/";
    const apiKey = '0db2b210052ac2389b97a0d37eb57c9b'; // Replace with your TMDb API key
    const movieId = movieIdNumber;
   async function fetchMovieDetails() {
      const language = 'en-US'; // Change as needed

      const url = `${tmdbBaseUrl}movie/${movieId}?api_key=${apiKey}&language=${language}`;

      try {
        const response = await fetch(url);
        const data = await response.json();

        // Update movie details on the webpage
        const posterPath = data.poster_path ? `https://image.tmdb.org/t/p/w500/${data.poster_path}` : '';
        const movieTitle = data.title || 'Movie Title';
        const movieOverview = data.overview || 'Movie overview not available.';

        document.getElementById('poster').src = posterPath;
        document.getElementById('movieTitle').textContent = movieTitle;
        document.getElementById('movieOverview').textContent = movieOverview;

        // Show movie details section
        document.getElementById('movieDetails').style.display = 'block';
      } catch (error) {
        console.error('Error fetching movie details:', error);
      }
    }

    // Fetch and display movie details from TMDb
    fetchMovieDetails();
    }


    //submit button click
    submitButton.addEventListener("click", () => {
      searchResultsNumber.style.display = 'block';

      const selectedGenre = genreDropdown.value;
      const selectedYear = yearDropdown.value;
      const selectedLanguage = languageDropdown.value;
      if (selectedGenre === "" && selectedYear === "" && selectedLanguage === "") { //making a default value if nithing is selected
        resultsText.textContent = 'Please make at least one selection.';
        searchResults.style.display = 'none'
        hideSearchButtons(showMoreButton, showAllButton);
        return;
      }
      const selectedOrder = sortDropdown.value;
      if (selectedOrder === 'azTitle') {
        movies.sort((a, b) => a.title.localeCompare(b.title));
      } else if (selectedOrder === 'azDirector') {
        movies.sort((a, b) => a.director.localeCompare(b.director));
      } else if (selectedOrder === 'numberYear') {
        movies.sort((a, b) => a.year - b.year);
      } else if (selectedOrder === 'default'){
        randomizeIndexesInPlace(movies);
      }
      const filteredMovies = movies.filter(movie => {
        const genreMatch = selectedGenre === "" || movie.genre === selectedGenre;
        const yearMatch = selectedYear === "" || movie.decade === selectedYear;
        const languageMatch = selectedLanguage === "" || movie.language === selectedLanguage;
        return genreMatch && yearMatch && languageMatch;
      });
      searchResults = filteredMovies.map(movie => `${movie.title}, ${movie.year}. Directed by ${movie.director}.`);
      itemsToShow = 1; // Reset itemsToShow to default value after every search
      currentEndIndex = itemsToShow; // Reset the currentEndIndex as well
      displayResults(searchResults, itemsToShow);
      if (searchResults.length <= itemsToShow) {
        hideSearchButtons(showMoreButton, showAllButton);
      } else {
        showSearchButtons(showMoreButton, showAllButton)
      }
    });

    function displayResults(results, endIndex) {
      if (results.length === 1) {
        searchResultsNumber.textContent = `Search results ${results.length} film:`;
      } else {
        searchResultsNumber.textContent = `Search results ${results.length} films:`;
      }
      if (results.length >= 1) {
        showSearchButtons(showMoreButton, showAllButton)
      } else {
        showMoreButton.style.display = 'none'
      }
      resultsText.innerHTML = "";
      
      for (let i = 0; i < endIndex && i < results.length; i++) { //making sure the loop does not exceed both the endIndex amount and the array length
        const resultElement = document.createElement("p");
        resultElement.textContent = results[i];
        resultsText.appendChild(resultElement);
        
        const movieInfoButton = document.createElement("button");
        movieInfoButton.textContent = 'want more movie info?'
        movieInfoButton.id = 'moreMovieInfo'; 
        
        movieInfoButton.addEventListener('click', () => {
          console.log('Movie info button clicked!');
          console.log('Movie ID:', movies[i].movieId);

          getMovieInfo(movies[i].movieId)
        });
        
        resultElement.appendChild(movieInfoButton);
      }
    }

    //show all buttons
    showAllButton.addEventListener("click", () => {
      itemsToShow = searchResults.length;
      currentEndIndex += itemsToShow;
      displayResults(searchResults, currentEndIndex);
      hideSearchButtons(showMoreButton, showAllButton)
    });

    //show more button
    showMoreButton.addEventListener("click", () => {
      currentEndIndex += itemsToShow; // Increase the end index with the amount being shown at a time
      displayResults(searchResults, currentEndIndex);
      if (currentEndIndex >= searchResults.length) {
        hideSearchButtons(showMoreButton, showAllButton)
      }
    });
    //randomise button
    const randomButton = document.getElementById('randomise')

    randomButton.addEventListener('click', function() {
      searchResultsNumber.style.display = 'none'
      hideSearchButtons(showMoreButton, showAllButton);

      function randomMovie(film) {
        const randomiseSelection = film[Math.floor(Math.random() * film.length)];
        return `${randomiseSelection.title}, ${randomiseSelection.year}. Directed by ${randomiseSelection.director}.`;
      }
      resultsText.textContent = randomMovie(movies)
    })
  </script>
</body>
</html>